<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#667eea">
  <title>Budget Familial</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23667eea'/><text y='75' font-size='80' text-anchor='middle' x='50' fill='white'>üí∞</text></svg>">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    
    #root {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* Loading spinner */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border: 4px solid #667eea;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Safe area padding */
    .safe-area-top {
      padding-top: env(safe-area-inset-top);
    }

    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="loading"></div>
  </div>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Storage wrapper using localStorage
    window.storage = {
      get: async (key) => {
        const value = localStorage.getItem(key);
        return value ? { key, value } : null;
      },
      set: async (key, value) => {
        localStorage.setItem(key, value);
        return { key, value };
      },
      delete: async (key) => {
        localStorage.removeItem(key);
        return { key, deleted: true };
      }
    };

    // Icon components (inline SVG)
    const Icon = ({ d, ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
      </svg>
    );

    const Wallet = () => <Icon d={["M21 12V7H5a2 2 0 0 1 0-4h14v4", "M3 5v14a2 2 0 0 0 2 2h16v-5", "M18 12a2 2 0 0 0 0 4h4v-4Z"]} />;
    const TrendingUp = () => <Icon d="m22 7-8.5 8.5-5-5L2 17" />;
    const TrendingDown = () => <Icon d="m22 17-8.5-8.5-5 5L2 7" />;
    const Plus = () => <Icon d={["M12 5v14", "M5 12h14"]} />;
    const X = () => <Icon d={["M18 6 6 18", "m6 6 12-12"]} />;
    const Target = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
    const PiggyBank = () => <Icon d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2V5z" />;
    const Users = () => <Icon d={["M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2", "M22 21v-2a4 4 0 0 0-3-3.87", "M16 3.13a4 4 0 0 1 0 7.75"]} />;
    const ShoppingCart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>;
    const Home = () => <Icon d={["m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z", "M9 22V12h6v10"]} />;
    const Car = () => <Icon d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />;
    const Utensils = () => <Icon d={["M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2", "M7 2v20", "M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"]} />;
    const Film = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="20" x="2" y="2" rx="2.18" ry="2.18"/><line x1="7" x2="7" y1="2" y2="22"/><line x1="17" x2="17" y1="2" y2="22"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="7" y1="7" y2="7"/><line x1="2" x2="7" y1="17" y2="17"/><line x1="17" x2="22" y1="17" y2="17"/><line x1="17" x2="22" y1="7" y2="7"/></svg>;
    const Heart = () => <Icon d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />;
    const Zap = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
    const CreditCard = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="22" height="16" x="1" y="4" rx="2" ry="2"/><line x1="1" x2="23" y1="10" y2="10"/></svg>;
    const BarChart3 = () => <Icon d={["M3 3v18h18", "M18 17V9", "M13 17V5", "M8 17v-3"]} />;

    // Main Budget App Component
    function BudgetApp() {
      const [salaires, setSalaires] = useState({ user: 0, conjoint: 0 });
      const [transactions, setTransactions] = useState([]);
      const [projets, setProjets] = useState([]);
      const [showModal, setShowModal] = useState(null);
      const [formData, setFormData] = useState({});
      const [activeView, setActiveView] = useState('dashboard');
      const [filtreCategorie, setFiltreCategorie] = useState('toutes');
      const [projetEnPaiement, setProjetEnPaiement] = useState(null);

      const categories = {
        'Alimentation': { icon: ShoppingCart, color: '#10b981' },
        'Logement': { icon: Home, color: '#3b82f6' },
        'Transport': { icon: Car, color: '#f59e0b' },
        'Restaurants': { icon: Utensils, color: '#ef4444' },
        'Divertissement': { icon: Film, color: '#8b5cf6' },
        'Sant√©': { icon: Heart, color: '#ec4899' },
        'Factures': { icon: Zap, color: '#06b6d4' },
        'Autre': { icon: CreditCard, color: '#6366f1' }
      };

      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        try {
          const salairesData = await window.storage.get('budget-salaires');
          const transactionsData = await window.storage.get('budget-transactions');
          const projetsData = await window.storage.get('budget-projets');
          
          if (salairesData) setSalaires(JSON.parse(salairesData.value));
          if (transactionsData) setTransactions(JSON.parse(transactionsData.value));
          if (projetsData) setProjets(JSON.parse(projetsData.value));
        } catch (error) {
          console.log('Premi√®re utilisation');
        }
      };

      const saveData = async (key, data) => {
        try {
          await window.storage.set(key, JSON.stringify(data));
        } catch (error) {
          console.error('Erreur de sauvegarde:', error);
        }
      };

      const calculerTotaux = () => {
        const revenus = transactions
          .filter(t => t.type === 'revenu')
          .reduce((acc, t) => acc + parseFloat(t.montant), 0);
        
        const depenses = transactions
          .filter(t => t.type === 'depense')
          .reduce((acc, t) => acc + parseFloat(t.montant), 0);
        
        const totalSalaires = parseFloat(salaires.user || 0) + parseFloat(salaires.conjoint || 0);
        const solde = totalSalaires + revenus - depenses;
        
        return { revenus: totalSalaires + revenus, depenses, solde };
      };

      const totaux = calculerTotaux();

      // Simplified UI for APK
      return (
        <div style={{
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          paddingBottom: '80px'
        }}>
          <div style={{
            padding: '2rem 1rem',
            maxWidth: '1200px',
            margin: '0 auto'
          }}>
            <h1 style={{
              color: 'white',
              textAlign: 'center',
              marginBottom: '2rem',
              fontSize: '2rem',
              fontWeight: '600'
            }}>
              üí∞ Budget Familial
            </h1>

            {/* Summary Cards */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
              gap: '1rem',
              marginBottom: '2rem'
            }}>
              <div style={{
                background: 'rgba(255,255,255,0.95)',
                borderRadius: '16px',
                padding: '1.5rem',
                boxShadow: '0 4px 16px rgba(0,0,0,0.1)'
              }}>
                <div style={{ color: '#10b981', marginBottom: '0.5rem' }}>
                  <TrendingUp />
                </div>
                <p style={{ fontSize: '0.875rem', color: '#718096', margin: '0 0 0.25rem 0' }}>
                  Revenus
                </p>
                <p style={{
                  fontSize: '1.5rem',
                  fontWeight: '700',
                  color: '#10b981',
                  margin: 0
                }}>
                  {totaux.revenus.toFixed(0)} $
                </p>
              </div>

              <div style={{
                background: 'rgba(255,255,255,0.95)',
                borderRadius: '16px',
                padding: '1.5rem',
                boxShadow: '0 4px 16px rgba(0,0,0,0.1)'
              }}>
                <div style={{ color: '#ef4444', marginBottom: '0.5rem' }}>
                  <TrendingDown />
                </div>
                <p style={{ fontSize: '0.875rem', color: '#718096', margin: '0 0 0.25rem 0' }}>
                  D√©penses
                </p>
                <p style={{
                  fontSize: '1.5rem',
                  fontWeight: '700',
                  color: '#ef4444',
                  margin: 0
                }}>
                  {totaux.depenses.toFixed(0)} $
                </p>
              </div>

              <div style={{
                background: 'rgba(255,255,255,0.95)',
                borderRadius: '16px',
                padding: '1.5rem',
                boxShadow: '0 4px 16px rgba(0,0,0,0.1)'
              }}>
                <div style={{ color: '#667eea', marginBottom: '0.5rem' }}>
                  <Wallet />
                </div>
                <p style={{ fontSize: '0.875rem', color: '#718096', margin: '0 0 0.25rem 0' }}>
                  Disponible
                </p>
                <p style={{
                  fontSize: '1.5rem',
                  fontWeight: '700',
                  color: totaux.solde >= 0 ? '#10b981' : '#ef4444',
                  margin: 0
                }}>
                  {totaux.solde.toFixed(0)} $
                </p>
              </div>
            </div>

            {/* Actions */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(2, 1fr)',
              gap: '1rem'
            }}>
              <button
                onClick={() => setShowModal('salaires')}
                style={{
                  background: 'rgba(255,255,255,0.95)',
                  border: 'none',
                  borderRadius: '16px',
                  padding: '1.5rem',
                  cursor: 'pointer',
                  boxShadow: '0 4px 16px rgba(0,0,0,0.1)',
                  fontSize: '1rem',
                  fontWeight: '600',
                  color: '#2d3748',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}
              >
                <Users />
                Configurer salaires
              </button>

              <button
                onClick={() => {
                  setShowModal('transaction');
                  setFormData({ type: 'depense', categorie: 'Autre' });
                }}
                style={{
                  background: 'rgba(255,255,255,0.95)',
                  border: 'none',
                  borderRadius: '16px',
                  padding: '1.5rem',
                  cursor: 'pointer',
                  boxShadow: '0 4px 16px rgba(0,0,0,0.1)',
                  fontSize: '1rem',
                  fontWeight: '600',
                  color: '#2d3748',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}
              >
                <Plus />
                Ajouter transaction
              </button>
            </div>

            {/* Transaction List */}
            {transactions.length > 0 && (
              <div style={{
                marginTop: '2rem',
                background: 'rgba(255,255,255,0.95)',
                borderRadius: '20px',
                padding: '1.5rem',
                boxShadow: '0 4px 16px rgba(0,0,0,0.1)'
              }}>
                <h2 style={{
                  margin: '0 0 1rem 0',
                  fontSize: '1.25rem',
                  fontWeight: '600',
                  color: '#2d3748'
                }}>
                  üìù Derni√®res transactions
                </h2>
                {transactions.slice(-5).reverse().map(t => (
                  <div key={t.id} style={{
                    padding: '1rem',
                    borderRadius: '12px',
                    background: 'rgba(0,0,0,0.02)',
                    marginBottom: '0.75rem',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}>
                    <div>
                      <p style={{
                        margin: '0 0 0.25rem 0',
                        fontWeight: '600',
                        color: '#2d3748',
                        fontSize: '0.875rem'
                      }}>
                        {t.description}
                      </p>
                      <p style={{
                        margin: 0,
                        fontSize: '0.75rem',
                        color: '#718096'
                      }}>
                        {t.categorie} ‚Ä¢ {t.date}
                      </p>
                    </div>
                    <p style={{
                      margin: 0,
                      fontSize: '1rem',
                      fontWeight: '700',
                      color: t.type === 'revenu' ? '#10b981' : '#ef4444'
                    }}>
                      {t.type === 'revenu' ? '+' : '-'}{parseFloat(t.montant).toFixed(0)} $
                    </p>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Modals would go here - simplified version */}
          
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BudgetApp />);
  </script>
</body>
</html>
